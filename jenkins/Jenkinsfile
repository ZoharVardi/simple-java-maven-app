pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        APP_REPO       = 'https://github.com/ZoharVardi/simple-java-maven-app.git'
        APP_DIR        = 'simple-java-maven-app'
        PREDEPLOY_JOB  = 'Pre-Deploy Check'   
    }

    triggers {
        githubPush()
    }

    stages {

        stage('Gate check (run pre-deploy pipeline)') {
            steps {
                script {
                    echo "Triggering pre-deploy job: ${env.PREDEPLOY_JOB}"

                    def pre = build job: env.PREDEPLOY_JOB, propagate: false, wait: true

                    echo "Pre-Deploy job result: ${pre.result}"

                    if (pre.result != 'SUCCESS') {
                        error "Deployment blocked: Pre-Deploy Check result = ${pre.result}"
                    } else {
                        echo "Gate open: Pre-Deploy Check SUCCESS, continuing with deploy pipeline"
                    }
                }
            }
        }

        stage('Clean Up Workspace') {
            steps {
                echo "Cleaning workspace..."
                deleteDir()
            }
        }

        stage('Clone Repo') {
            steps {
                echo "Cloning demo app from ${env.APP_REPO}"
                sh "git clone ${env.APP_REPO}"
            }
        }

        stage('Build') {
            steps {
                dir(env.APP_DIR) {
                    echo "Running mvn clean install"
                    sh "mvn clean install -B"
                }
            }
        }

        stage('Test') {
            steps {
                dir(env.APP_DIR) {
                    echo "Running mvn test"
                    sh "mvn test"
                }
            }
        }

        stage('Deploy Service') {
            steps {
                echo "=== Dummy deploy step ==="
                echo "Here I would run something like:"
                echo "kubectl apply -f k8s/deployment.yaml"
                echo "kubectl apply -f k8s/service.yaml"
            }
        }
    }

    post {
        success {
            echo "deploy-app pipeline finished SUCCESSFULLY"
        }
        failure {
            echo "deploy-app pipeline FAILED (check logs above)"
        }
    }
}
